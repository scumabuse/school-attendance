generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Specialty {
  id             Int             @id @default(autoincrement())
  code           String          @unique
  name           String
  durationYears  Int
  groups         Group[]
  qualifications Qualification[]

  @@index([code])
  @@map("specialties")
}

model Qualification {
  id          Int               @id @default(autoincrement())
  specialtyId Int
  type        QualificationType
  name        String
  specialty   Specialty         @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@unique([specialtyId, type])
  @@index([specialtyId])
  @@map("qualifications")
}

model Group {
  id            String       @id @default(uuid()) @db.Uuid
  name          String       @unique
  admissionYear Int
  course        Int
  specialtyId   Int
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  curatorId     String?      @db.Uuid
  attendances   Attendance[]
  curator       User?        @relation("UserCuratesGroup", fields: [curatorId], references: [id])
  specialty     Specialty    @relation(fields: [specialtyId], references: [id])
  students      Student[]
  practiceDays PracticeDay[]

  @@index([admissionYear])
  @@index([course])
  @@index([name])
  @@index([specialtyId])
  @@index([curatorId])
  @@map("groups")
}

model User {
  id       String   @id @default(uuid()) @db.Uuid
  login    String   @unique
  password String
  role     UserRole
  fullName String?

  // Связь со студентом
  studentProfile Student?

  createdAt         DateTime     @default(now())
  updatedAttendance Attendance[] @relation("UpdatedBy")
  curatedGroups     Group[]      @relation("UserCuratesGroup")

  @@map("users")
}

model Student {
  id       String @id @default(uuid()) @db.Uuid
  fullName String
  groupId  String @db.Uuid

  // Новое поле для связи с аккаунтом
  userId String? @unique @db.Uuid
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime     @default(now())
  attendances Attendance[]
  group       Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([fullName, groupId])
  @@map("students")
}

model Attendance {
  id   String   @id @default(uuid()) @db.Uuid
  date DateTime @db.Date

  // 1. Делаем lessonId временнно необязательным (?)
  lessonId Int?
  lesson   LessonSchedule? @relation(fields: [lessonId], references: [id])

  studentId   String           @db.Uuid
  groupId     String           @db.Uuid
  status      AttendanceStatus
  updatedById String?          @db.Uuid
  updatedAt   DateTime         @updatedAt
  markedAt    DateTime?
  lateMinutes Int?

  // Обратные связи, которые требует Prisma:
  group     Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  updatedBy User?   @relation("UpdatedBy", fields: [updatedById], references: [id])

  // 2. ВРЕМЕННО комментируем уникальность по lessonId, чтобы база не ругалась на пустые поля
  // @@unique([studentId, date, lessonId]) 

  @@index([groupId, date])
  @@index([date])
  @@index([groupId])
  @@map("attendance")
}

model Holiday {
  id   Int      @id @default(autoincrement())
  date DateTime @unique @db.Date
  name String

  @@index([date])
  @@map("holidays")
}

model PracticeDay {
  id        String   @id @default(uuid())
  groupId   String   @db.Uuid  
  date      DateTime @db.Date
  name      String?

  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, date])
}

// Расписание пар
// dayOfWeek: 1 = Пн, 2 = Вт, 3 = Ср, 4 = Чт, 5 = Пт
// pairNumber: 0 = классный час (если нужен), 1..7 — пары
model LessonSchedule {
  id         Int      @id @default(autoincrement())
  dayOfWeek  Int
  pairNumber Int
  startTime  String // формат "HH:mm"
  endTime    String // формат "HH:mm"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // --- ДОБАВЬ ЭТУ СТРОКУ НИЖЕ ---
  attendances Attendance[]
  // ------------------------------

  @@unique([dayOfWeek, pairNumber])
  @@map("lesson_schedule")
}

enum UserRole {
  TEACHER
  HEAD
  ADMIN
  STUDENT
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  SICK
  ITHUB
  VALID_ABSENT
  DUAL
  LATE
}

enum QualificationType {
  IT_TECHNICIAN
  WEB_DESIGNER
}

model QrToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  teacherId String   @db.Uuid // ID преподавателя/заведующей, который генерирует QR код
  lessonId  Int? // ID пары, на которую идет отметка (опционально)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([teacherId])
  @@map("qr_tokens")
}
