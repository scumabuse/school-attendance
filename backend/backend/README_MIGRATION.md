# Инструкция по применению миграции

## Безопасная миграция базы данных

Эта миграция безопасна и **НЕ УДАЛИТ** существующие данные. Она только:
- Добавляет поле `teacherId` в таблицу `qr_tokens` (если его еще нет)
- Добавляет поле `lessonId` как опциональное (если его еще нет)
- Создает необходимые индексы
- Все существующие данные сохраняются

## Как применить миграцию

### Вариант 1: Через Node.js скрипт (рекомендуется)

```bash
cd College_Attendance/backend/backend
node apply-migration.js
```

### Вариант 2: Вручную через Prisma

```bash
cd College_Attendance/backend/backend

# Применить миграцию
npx prisma migrate deploy

# Перегенерировать Prisma клиент
npx prisma generate
```

### Вариант 3: Через npm скрипт (если есть)

```bash
cd College_Attendance/backend/backend
npm run prisma:migrate
npx prisma generate
```

## Что делает миграция

Миграция `20251219000000_add_teacherId_to_qr_tokens`:

1. **Проверяет существование таблицы** `qr_tokens`
   - Если таблицы нет - создает её
   - Если таблица есть - ничего не меняет

2. **Добавляет поле `teacherId`** (UUID, nullable)
   - Использует `IF NOT EXISTS`, поэтому безопасно
   - Существующие записи получат `NULL` в этом поле (это нормально)

3. **Добавляет поле `lessonId`** (INTEGER, nullable, опционально)

4. **Создает индекс** для быстрого поиска по `teacherId`

5. **Добавляет внешний ключ** на таблицу `users` для целостности данных

## Важно!

- ✅ Миграция использует транзакции для безопасности
- ✅ Все существующие данные сохраняются
- ✅ Можно применить миграцию несколько раз (идемпотентна)
- ✅ Не требует остановки сервера

После применения миграции перезапустите сервер, чтобы изменения вступили в силу.

