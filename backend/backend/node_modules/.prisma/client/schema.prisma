generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Specialty {
  id             Int             @id @default(autoincrement())
  code           String          @unique
  name           String
  durationYears  Int
  groups         Group[]
  qualifications Qualification[]

  @@index([code])
  @@map("specialties")
}

model Qualification {
  id          Int               @id @default(autoincrement())
  specialtyId Int
  type        QualificationType
  name        String
  specialty   Specialty         @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@unique([specialtyId, type])
  @@index([specialtyId])
  @@map("qualifications")
}

model Group {
  id            String       @id @default(uuid()) @db.Uuid
  name          String       @unique
  admissionYear Int
  course        Int
  specialtyId   Int
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  curatorId     String?      @db.Uuid
  attendances   Attendance[]
  curator       User?        @relation("UserCuratesGroup", fields: [curatorId], references: [id])
  specialty     Specialty    @relation(fields: [specialtyId], references: [id])
  students      Student[]

  @@index([admissionYear])
  @@index([course])
  @@index([name])
  @@index([specialtyId])
  @@index([curatorId])
  @@map("groups")
}

model User {
  id                String       @id @default(uuid()) @db.Uuid
  login             String       @unique
  password          String
  role              UserRole
  fullName          String?
  createdAt         DateTime     @default(now())
  updatedAttendance Attendance[] @relation("UpdatedBy")
  curatedGroups     Group[]      @relation("UserCuratesGroup")

  @@map("users")
}

model Student {
  id          String       @id @default(uuid()) @db.Uuid
  fullName    String
  groupId     String       @db.Uuid
  createdAt   DateTime     @default(now())
  attendances Attendance[]
  group       Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([fullName, groupId])
  @@map("students")
}

model Attendance {
  id          String           @id @default(uuid()) @db.Uuid
  date        DateTime         @db.Date
  studentId   String           @db.Uuid
  groupId     String           @db.Uuid
  status      AttendanceStatus
  updatedById String?          @db.Uuid
  updatedAt   DateTime         @updatedAt
  markedAt    DateTime? // Time when attendance was marked
  lateMinutes Int? // Minutes late (for LATE status)
  group       Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student     Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  updatedBy   User?            @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@unique([studentId, date])
  @@index([groupId, date])
  @@index([date])
  @@index([groupId])
  @@map("attendance")
}

model Holiday {
  id   Int      @id @default(autoincrement())
  date DateTime @unique @db.Date
  name String

  @@index([date])
  @@map("holidays")
}

enum UserRole {
  TEACHER
  HEAD
  ADMIN
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  SICK
  ITHUB
  VALID_ABSENT
  LATE
}

enum QualificationType {
  IT_TECHNICIAN
  WEB_DESIGNER
}
